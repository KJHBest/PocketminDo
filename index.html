<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>í¬ì¼“ëª¬ë¼ì´í¬ | ì „ì„¤ ì”ë””/íŠ¸ë ˆì´ë„ˆ | 18íƒ€ì…/90ì¢… | í€˜ìŠ¤íŠ¸/ê±°ë‹¤ì´ë§¥ìŠ¤</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --vw: 900px; --vh: 560px; }
  * { box-sizing: border-box; }
  body { margin:0; background:#cfe8b5; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  #wrap { width: var(--vw); margin: 20px auto; display:grid; grid-template-columns: 260px 1fr; gap:12px; }
  #bag { background:#fff; border-radius:12px; padding:12px; box-shadow:0 6px 16px rgba(0,0,0,.1); }
  #bag h3 { margin:0 0 8px; font-size:15px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  #bag small { color:#64748b; font-weight:600; }
  #party { list-style:none; margin:8px 0 0; padding:0; max-height:240px; overflow:auto; }
  #party li { background:#f6f8fb; margin-bottom:6px; padding:8px; border-radius:10px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  #party li .meta { font-size:13px; }
  #party li .hp { font-size:12px; color:#475569; }
  #party li .btn { background:#2563eb; color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
  #party li.fainted { opacity:.6; }
  #party li.active { outline:2px solid #2563eb; }
  .toolbar { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .toolbar .btn { background:#0ea5e9; color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; font-size:12px; }
  .toolbar .btn.secondary { background:#64748b; }
  .badge { display:inline-block; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:11px; }
  .band { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#374151; }
  .band .dot { width:10px; height:10px; border-radius:50%; background:#ef4444; box-shadow:0 0 8px #ef4444aa; }
  .band.off .dot { background:#9ca3af; box-shadow:none; }

  #questBox { margin-top:10px; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:10px; padding:10px; color:#1f2937; font-size:12px; }
  #questBox h4 { margin:0 0 8px; font-size:13px; }
  .qitem { margin:4px 0; }
  .qdone { color:#059669; font-weight:700; }
  .qtype { font-weight:700; }

  #game { position: relative; height: var(--vh); background:#88c070; border-radius:12px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,.12); }
  #camera { position:absolute; inset:0; overflow:hidden; }
  #map { position:absolute; width:2000px; height:1200px; background:
    linear-gradient(#7ecb5a,#7ecb5a) padding-box,
    repeating-linear-gradient(0deg, transparent 0 38px, rgba(255,255,255,.06) 38px 40px),
    repeating-linear-gradient(90deg, transparent 0 38px, rgba(255,255,255,.06) 38px 40px);
    border: 16px solid #6bb14a; border-radius:6px; }
  .grass { position:absolute; background: repeating-linear-gradient(45deg,#5aa94a 0 6px,#67bd57 6px 12px); border-radius:8px; opacity:.9; }
  .grass.legend { background: repeating-linear-gradient(45deg,#7c3aed 0 6px,#a78bfa 6px 12px); box-shadow:0 0 14px #a78bfa66 inset; }
  .road { position:absolute; background:#c9b48a; border:2px dashed #ad976c; border-radius:8px; }

  #center { position:absolute; width:260px; height:160px; background:#fff; border:3px solid #ef4444; border-radius:12px; left:1550px; top:300px; box-shadow:0 6px 16px rgba(0,0,0,.15); }
  #center::before { content:"í¬ì¼“ëª¬ì„¼í„°"; position:absolute; left:0; right:0; top:-28px; text-align:center; font-weight:800; color:#ef4444; text-shadow:0 1px 0 #fff; }
  #centerDoor { position:absolute; width:60px; height:70px; left:100px; bottom:0; background:#ef4444; border:4px solid #b91c1c; border-bottom:none; border-radius:10px 10px 0 0; }

  #trainerNPC { position:absolute; left:1280px; top:520px; width:24px; height:24px; border-radius:6px; background:#1f2937; box-shadow:0 0 0 3px #fbbf24 inset, 0 0 10px #00000055; }
  #trainerNPC::after{ content:'íŠ¸ë ˆì´ë„ˆ'; position:absolute; left:-10px; top:-22px; font-size:12px; font-weight:800; color:#111827; text-shadow:0 1px 0 #fff; }

  #player { position:absolute; width:28px; height:28px; border-radius:50%; background:#2b2b2b; box-shadow:0 0 0 3px #ffd166 inset; }
  #hud { position:absolute; top:8px; left:8px; right:8px; display:flex; justify-content:space-between; pointer-events:none; }
  .pill { background:#00000040; color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; }

  /* ë°°í‹€ */
  #battle { position:absolute; inset:0; background:#fff; display:none; }
  #battle .stage { position:absolute; inset:0; padding:14px; display:grid; grid-template-rows: 1fr auto; gap:8px; }
  .arena { position:relative; background:linear-gradient(#e7f0ff, #cde6ff 50%, #def5d6 50%, #bfe9b2); border-radius:10px; box-shadow: inset 0 0 40px rgba(0,0,0,.08); }
  .side { position:absolute; width:50%; height:100%; top:0; display:flex; align-items:flex-end; justify-content:center; }
  .left { left:0; } .right { right:0; align-items:center; }
  canvas.sprite { width:240px; height:240px; image-rendering: pixelated; transition: transform .2s, filter .2s; }
  #playerMon.gmax { transform: scale(1.35); filter: drop-shadow(0 0 16px rgba(239,68,68,.6)); }
  .bars { position:absolute; left:12px; right:12px; top:8px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .card { background:#f7f9fc; border:1px solid #e4ecf5; border-radius:10px; padding:8px; }
  .name { font-weight:700; font-size:14px; margin-bottom:4px; display:flex; gap:8px; align-items:center; }
  .status { font-size:11px; padding:2px 6px; border-radius:999px; background:#fde68a; color:#92400e; }
  .hpbar { height:12px; background:#e9eef3; border-radius:999px; overflow:hidden; }
  .hpbar>div { height:100%; transition:width .25s; }
  .hp-green { background:#43aa8b; } .hp-yellow{ background:#f9c74f; } .hp-red{ background:#f94144; }
  #log { background:#0f172a; color:#dbeafe; height:110px; border-radius:10px; padding:10px; overflow:auto; font-size:14px; }
  #actions { display:flex; flex-wrap:wrap; gap:8px; }
  button.btn { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
  button.btn.secondary { background:#64748b; }
  button.btn.warn { background:#ef4444; }
  button.btn:disabled { opacity:.5; cursor:not-allowed; }

  /* ì˜¤ë²„ë ˆì´ */
  .overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); }
  .cardBox { background:#fff; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2); }

  #centerCard { width:420px; }
  #centerCard .row { display:flex; gap:8px; flex-wrap:wrap; }
  #centerCard .btn { padding:8px 12px; border-radius:10px; border:none; background:#10b981; color:#fff; cursor:pointer; font-weight:700; }
  #centerCard .btn.close { background:#64748b; }

  #dexUI { z-index: 5; }
  #dexCard { width: 700px; }
  #dexHeader { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  #dexList { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; max-height: 360px; overflow:auto; }
  .dexItem { border:2px solid #e5e7eb; border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center; cursor:pointer; }
  .dexItem.sel { border-color:#2563eb; box-shadow:0 0 0 2px #2563eb33 inset; }
  .dexMeta { font-size:13px; }
  .dexMeta .sub { color:#64748b; font-size:12px; }
</style>
</head>
<body>
<div id="wrap">
  <aside id="bag">
    <h3>
      ğŸ’ ë‚´ í¬ì¼“ëª¬ <small id="capInfo">0 / 5</small>
    </h3>
    <div class="band off" id="bandInfo"><span class="dot"></span> ë‹¤ì´ë§¥ìŠ¤ ë°´ë“œ: ì—†ìŒ</div>
    <ul id="party"></ul>
    <div class="toolbar">
      <button id="openDexBtn" class="btn">ğŸ“˜ ë„ê° ì—´ê¸°</button>
      <button id="healBtn" class="btn secondary" title="ì„¼í„° ì• Eí‚¤ì™€ ë™ì¼">ğŸ’– ì „ì› íšŒë³µ</button>
    </div>
    <div id="questBox">
      <h4>ğŸ—’ï¸ í€˜ìŠ¤íŠ¸</h4>
      <div id="qCatch5" class="qitem">5ë§ˆë¦¬ ì¡ê¸°: 0/5</div>
      <div id="qCatch10" class="qitem">10ë§ˆë¦¬ ì¡ê¸°: 0/10</div>
      <div id="qType" class="qitem">íŠ¹ì • íƒ€ì…(3ë§ˆë¦¬): -</div>
      <div class="qitem" style="margin-top:6px;color:#6b7280;">
        â¬› ì´ˆë¡ ì”ë””: ì¼ë°˜ ì¶œí˜„ Â· ğŸŸª ë³´ë¼ ì”ë””: <b>ì „ì„¤ ì „ìš©</b><br/>
        ğŸ¤ íŠ¸ë ˆì´ë„ˆ ê·¼ì²˜ì—ì„œ <b>T</b>í‚¤ë¡œ ë°°í‹€
      </div>
    </div>
    <hr />
    <div style="font-size:12px;color:#475569;line-height:1.5">
      â€¢ ë°©í–¥í‚¤ ì´ë™, ì”ë””ì—ì„œ ë°°í‹€ ë°œìƒ<br>
      â€¢ <b>ì„¼í„° ë¬¸ ì•ì—ì„œ E</b> â†’ ì¦‰ì‹œ ì „ì› íšŒë³µ<br>
      â€¢ HP 0ì€ <b>ê¸°ì ˆ</b> (êµì²´/ì¹˜ë£Œ í•„ìš”)<br>
      â€¢ <b>ì¤‘ë³µ í¬íš</b>: ë„ê° ë¹„ë“±ë¡, íŒŒí‹° ë™ì¼ ì¢… <b>ë ˆë²¨ +1</b><br>
      â€¢ <b>ë…</b>: ë… ê¸°ìˆ  ë§ìœ¼ë©´ ìƒíƒœì´ìƒ, <b>5ì´ˆë§ˆë‹¤ -2</b>(ì „íˆ¬ ì¤‘)<br>
      â€¢ <b>ê°€ë°© ì œí•œ</b>: ìµœëŒ€ <b>5ë§ˆë¦¬</b><br>
      â€¢ <b>KO ë³´ìƒ</b>: ì“°ëŸ¬ëœ¨ë¦° ë‚´ í¬ì¼“ëª¬ <b>ë ˆë²¨ +1</b><br>
      â€¢ <b>ë‹¤ì´ë§¥ìŠ¤ ë°´ë“œ</b>: <b>í€˜ìŠ¤íŠ¸</b> â€˜í¬ì¼“ëª¬ 5ë§ˆë¦¬ ì¡ê¸°â€™ ì™„ë£Œ ë³´ìƒ<br>
      â€¢ <b>ë„ê° êµì²´</b>: ë„ê°ì—ì„œ í¬ì¼“ëª¬ì„ <u>í´ë¦­</u> â†’ ì¢Œì¸¡ íŒŒí‹°ì—ì„œ <u>êµì²´í•  ì¹¸</u> í´ë¦­
    </div>
  </aside>

  <main id="game">
    <div id="camera">
      <div id="map">
        <div class="road" style="left:200px; top:200px; width:1200px; height:60px;"></div>
        <div class="road" style="left:1200px; top:200px; width:60px; height:500px;"></div>

        <!-- ì¼ë°˜ ì”ë”” -->
        <div class="grass" style="left:280px; top:320px; width:500px; height:260px;"></div>
        <div class="grass" style="left:900px; top:620px; width:380px; height:260px;"></div>
        <div class="grass" style="left:1400px; top:120px; width:420px; height:260px;"></div>
        <div class="grass" style="left:300px; top:820px; width:520px; height:240px;"></div>

        <!-- ì „ì„¤ ì „ìš© ì”ë””(ë³´ë¼) -->
        <div class="grass legend" style="left:1520px; top:780px; width:360px; height:220px;" title="ì „ì„¤ í¬ì¼“ëª¬ ì „ìš©"></div>

        <div id="center"><div id="centerDoor" title="Eí‚¤ë¡œ ì¦‰ì‹œ íšŒë³µ"></div></div>
        <div id="trainerNPC" title="íŠ¸ë ˆì´ë„ˆ(Tí‚¤ë¡œ ë°°í‹€)"></div>
        <div id="player" title="í”Œë ˆì´ì–´"></div>
      </div>
    </div>

    <div id="hud">
      <div class="pill" id="tip">ì”ë””ì—ì„œ ì•¼ìƒ í¬ì¼“ëª¬ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</div>
      <div class="pill" id="where">â€”</div>
    </div>

    <!-- ë°°í‹€ -->
    <section id="battle">
      <div class="stage">
        <div class="arena">
          <div class="bars">
            <div class="card">
              <div class="name" id="pName">í”¼ì¹´ì¸„ Lv.5 <span id="pStatus" class="status" style="display:none"></span></div>
              <div class="hpbar"><div id="pHP" class="hp-green" style="width:100%"></div></div>
            </div>
            <div class="card">
              <div class="name" id="wName">??? Lv.3 <span id="wStatus" class="status" style="display:none"></span></div>
              <div class="hpbar"><div id="wHP" class="hp-green" style="width:100%"></div></div>
            </div>
          </div>
          <div class="side left"><canvas id="playerMon" class="sprite" width="240" height="240"></canvas></div>
          <div class="side right"><canvas id="wildMon" class="sprite" width="240" height="240"></canvas></div>
        </div>
        <div>
          <div id="log"></div>
          <div id="actions">
            <button id="act1" class="btn">ìŠ¤í‚¬1</button>
            <button id="act2" class="btn">ìŠ¤í‚¬2</button>
            <button id="act3" class="btn">ìŠ¤í‚¬3</button>
            <button id="gmaxBtn" class="btn" style="display:none;background:#ef4444;">ê±°ë‹¤ì´ë§¥ìŠ¤</button>
            <button id="switchBtn" class="btn secondary">êµì²´</button>
            <button id="catchBtn" class="btn secondary" disabled>í¬ì¼“ëª¬ë³¼</button>
            <button id="runBtn" class="btn warn">ë„ë§</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ì„¼í„° UI -->
    <div id="centerUI" class="overlay">
      <div id="centerCard" class="cardBox">
        <h4>ğŸ§ª í¬ì¼“ëª¬ ì¹˜ë£Œê¸°</h4>
        <p style="margin-top:4px; color:#334155; font-size:14px;">ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ íŒŒí‹°ì˜ ëª¨ë“  í¬ì¼“ëª¬ì´ ì¦‰ì‹œ íšŒë³µë©ë‹ˆë‹¤.</p>
        <div class="row" style="margin-top:10px;">
          <button id="healAll" class="btn">ì „ì› íšŒë³µ</button>
          <button id="closeCenter" class="btn close">ë‹«ê¸°</button>
        </div>
      </div>
    </div>

    <!-- ë„ê° UI -->
    <div id="dexUI" class="overlay">
      <div id="dexCard" class="cardBox">
        <div id="dexHeader">
          <h4>ğŸ“˜ ë„ê° (ì¡ì€ ì¢…ë§Œ í‘œì‹œ)</h4>
          <button id="closeDex" class="btn" style="background:#64748b; border:none; padding:8px 12px; border-radius:10px; color:#fff; cursor:pointer; font-weight:700;">ë‹«ê¸°</button>
        </div>
        <div id="dexList"></div>
        <p id="dexHint" style="margin-top:8px; color:#334155; font-size:12px;">
          ë„ê° ì¹´ë“œë¥¼ í´ë¦­í•´ <b>êµì²´ ì†ŒìŠ¤</b>ë¥¼ ì„ íƒí•œ ë’¤, ì¢Œì¸¡ íŒŒí‹°ì—ì„œ <b>êµì²´í•  ì¹¸</b>ì„ í´ë¦­í•˜ì„¸ìš”.
        </p>
      </div>
    </div>

    <!-- í¬íš êµì²´ UI -->
    <div id="swapUI" class="overlay">
      <div id="swapCard" class="cardBox" style="width:520px;">
        <h4>ğŸ¯ í¬ì¼“ëª¬ë³¼ - êµì²´í•  ì¹¸ ì„ íƒ</h4>
        <p style="margin-top:4px;color:#334155;font-size:13px">
          ì¡ì€ í¬ì¼“ëª¬ì„ íŒŒí‹°ì˜ í•œ ì¹¸ê³¼ <b>êµì²´</b>í•©ë‹ˆë‹¤. (ê°€ë°© í™•ì¥ ì—†ìŒ)
        </p>
        <ul id="swapList" style="list-style:none;margin:10px 0;padding:0;display:grid;grid-template-columns:repeat(2,1fr);gap:8px"></ul>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
          <button id="swapCancel" class="btn" style="background:#64748b;">ë„ê°ë§Œ ë“±ë¡</button>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* =========================
   1) íƒ€ì…/ê¸°ìˆ /ë„ê°(18íƒ€ì… Ã— 5 = 90ì¢…) + ì „ì„¤ 3ì¢…(ë³„ë„ í’€)
========================= */
const TYPES = [
  'electric','fire','water','grass','rock','flying','poison','ice','psychic','ground',
  'normal','fighting','bug','ghost','dragon','dark','steel','fairy'
];

const TYPE_KO = {
  electric:'ì „ê¸°', fire:'ë¶ˆê½ƒ', water:'ë¬¼', grass:'í’€', rock:'ë°”ìœ„', flying:'ë¹„í–‰', poison:'ë…', ice:'ì–¼ìŒ', psychic:'ì—ìŠ¤í¼', ground:'ë•…',
  normal:'ë…¸ë§', fighting:'ê²©íˆ¬', bug:'ë²Œë ˆ', ghost:'ê³ ìŠ¤íŠ¸', dragon:'ë“œë˜ê³¤', dark:'ì•…', steel:'ê°•ì² ', fairy:'í˜ì–´ë¦¬'
};

const BASE_NAMES = {
  electric:['ì „ê¹ƒë²Œ','ë³¼íŠ¸ì¥','ìŠ¤íŒŒí¬ë§','ë¼ì´íŠ¸ì˜¨','ì¨ì§€íŒ'],
  fire:['ë¶ˆë„ë§ˆ','í™”ì—¼êµ¬ë¦¬','í™ì—¼ëƒ¥','í”Œë ˆì–´ë§','ë¸”ë ˆì´ì¦ˆ'],
  water:['ë¬¼ë°©ìš¸','íŒŒë„ë§','í•´ì´ˆêµ°','ë²„ë¸”í•€','ë””í”„ë¸”ë£¨'],
  grass:['í’€ëª½','ìƒˆì‹¹í†±','ë¦¬í”„ë ˆì˜¤','ëª¨ìŠ¤ì½”','ë°”ì§ˆëŸ¬'],
  rock:['ëŒí†¤','ë°”ìœ„ë™','ê·¸ëœì•„ì´','ì„í¬ë©','ì˜¤íŒ”ëŸ°'],
  flying:['ë°¤ë¶€ì—‰','ìœˆë“œìœ™','ì œíŠ¸ë²„ë“œ','ìŠ¤ì¹´ì´ë§','ê²Œì¼í•€'],
  poison:['ë…í•´ê³¨','í†¡ì‹œë“œ','ë² ë†ˆí•µ','í¼í”Œë§','ìŠ¤ëª¨ê·¸ëŸ°'],
  ice:['ì„œë¦¬í•µ','ìŠ¤ë…¸ë¸Œ','ì•„ì´ìŠ¤íŒ¡','í”„ë¦¬ì§“','ê¸€ë ˆì´ì¦ˆ'],
  psychic:['ë©˜íƒˆë§','í…”ë ˆì˜¤','ì˜¤ë¼íë¸Œ','ë“œë¦¼í•€','ì—ìŠ¤í”¼ì˜¨íŠ¸'],
  ground:['ë‘ë”ë§','ìƒŒë“œë°±','í´ë ˆì´í˜¼','í…Œë¼ëª°','í€˜ì´í¬'],
  normal:['ì´ˆì›ì¥','ë‹¬ë¦¬í† ë¼','ë°°ë¶€ë¥´ê³°','ìŠ¤í…ìº£','ëª¨ë…¸í†¤'],
  fighting:['íŒŒì›Œí€ì¹˜','í‚¥ëª½','íƒœí´ëŸ¬','ì•”ë¸Œë ˆì´ì»¤','í˜¸ì „ë‘'],
  bug:['ìì‚¬ê·€ë²Œ','ë¹„í‹€ë§','ìºí„°ë˜í”„','í•˜ë‹ˆë¹„','ë¹„í‹€í”„ë¼ì„'],
  ghost:['ê³ ìŠ¤íŠ¸í•µ','ì‰ì´ë“œí•€','ë‚˜ì´íŠ¸ë³¼','ìŠ¤í™íŠ¸ë¼','ë§ë ¹ë§'],
  dragon:['ìƒˆë¼ë£¡','ë¹„ëŠ˜ë§','ìŠ¤ì¹´ì´ë“œë˜','í…Œë¼ë“œë˜','ìµœìƒë£¡'],
  dark:['ë‹¤í¬í­','ë‚˜ì´íŠ¸ìš¸í”„','ì„€ë„ìš°ë§','ë¬¸ë„ê·¸','ë¸”ë™ìº£'],
  steel:['ê¸ˆì†ë‘ë”','ì•„ì´ì–¸í­','ë©”íƒˆí´ë¡œ','ê¸°ì–´ë§','í‹°íƒ€ëŠ„'],
  fairy:['ìš”ì •ì”¨ì•—','ìŠ¤ìœ—ë²¨','ë¬¸í”¼ìŠ¤','í•‘í¬ë§','ë£¨ë¯¸ì—˜']
};

const TYPE_MOVESETS = {
  electric: [
    {id:'thunder', label:'âš¡ 100ë§Œ ë³¼íŠ¸', power:14, effect:'paralyze', mtype:'electric'},
    {id:'quick',   label:'ë¹ ë¥¸ê³µê²©', power:9, mtype:'normal'},
    {id:'charge',  label:'ì¶©ì „(íšŒë³µ)', power:0, effect:'heal', amount:0.2, mtype:'electric'}
  ],
  fire: [
    {id:'flame',   label:'í™”ì—¼ë°©ì‚¬', power:13, mtype:'fire'},
    {id:'scratch', label:'í• í€´ê¸°', power:9, mtype:'normal'},
    {id:'warm',    label:'ì˜¨ì—´(íšŒë³µ)', power:0, effect:'heal', amount:0.18, mtype:'fire'}
  ],
  water: [
    {id:'surf',    label:'íŒŒë„íƒ€ê¸°', power:13, mtype:'water'},
    {id:'splash',  label:'ë¬¼ë³´ë¼', power:9, mtype:'water'},
    {id:'soothe',  label:'ìˆ˜ë¶„ë³´í˜¸(íšŒë³µ)', power:0, effect:'heal', amount:0.18, mtype:'water'}
  ],
  grass: [
    {id:'leaf',    label:'ë¦¬í”„ë¸”ë ˆì´ë“œ', power:13, mtype:'grass'},
    {id:'vine',    label:'ë©êµ´ì±„ì°', power:9, mtype:'grass'},
    {id:'photosyn',label:'ê´‘í•©ì„±(íšŒë³µ)', power:0, effect:'heal', amount:0.22, mtype:'grass'}
  ],
  rock: [
    {id:'slide',   label:'ë¡ìŠ¬ë¼ì´ë“œ', power:13, mtype:'rock'},
    {id:'throw',   label:'ë°”ìœ„ë˜ì§€ê¸°', power:9, mtype:'rock'},
    {id:'harden',  label:'ê²½í™”(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.16, mtype:'rock'}
  ],
  flying: [
    {id:'aircut',  label:'ì—ì–´ì»·í„°', power:12, mtype:'flying'},
    {id:'peck',    label:'ìª¼ê¸°', power:9, mtype:'flying'},
    {id:'draft',   label:'ìƒìŠ¹ê¸°ë¥˜(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.16, mtype:'flying'}
  ],
  poison: [
    {id:'jab',     label:'ë…ì°Œë¥´ê¸°', power:12, mtype:'poison'},
    {id:'smog',    label:'ìŠ¤ëª¨ê·¸', power:9,  mtype:'poison'},
    {id:'toxheal', label:'í•´ë…(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.16, mtype:'poison'}
  ],
  ice: [
    {id:'beam',    label:'ì–¼ìŒë¹”', power:13, mtype:'ice'},
    {id:'shard',   label:'ì–¼ìŒì¡°ê°', power:9, mtype:'ice'},
    {id:'frost',   label:'ì„œë¦¬ë³´í˜¸(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.16, mtype:'ice'}
  ],
  psychic: [
    {id:'psy',     label:'ì‚¬ì´ì½”í‚¤ë„¤ì‹œìŠ¤', power:13, mtype:'psychic'},
    {id:'confuse', label:'í˜¼ë€íŒŒë™', power:9, mtype:'psychic'},
    {id:'focus',   label:'ëª…ìƒ(íšŒë³µ)', power:0, effect:'heal', amount:0.2, mtype:'psychic'}
  ],
  ground: [
    {id:'quake',   label:'ì§€ì§„', power:14, mtype:'ground'},
    {id:'throw',   label:'í™ë©ì´ë˜ì§€ê¸°', power:9, mtype:'ground'},
    {id:'brace',   label:'ë‹¨ë‹¨í•´ì§€ê¸°(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.16, mtype:'ground'}
  ],
  normal: [
    {id:'tackle',  label:'ëª¸í†µë°•ì¹˜ê¸°', power:11, mtype:'normal'},
    {id:'quick',   label:'ì†ê³µ', power:9, mtype:'normal'},
    {id:'rest',    label:'íœ´ì‹(íšŒë³µ)', power:0, effect:'heal', amount:0.18, mtype:'normal'}
  ],
  fighting: [
    {id:'punch',   label:'ë©”ê°€í€ì¹˜', power:13, mtype:'fighting'},
    {id:'kick',    label:'í•˜ì´í‚¥', power:12, mtype:'fighting'},
    {id:'guard',   label:'ê¸°í•©(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.14, mtype:'fighting'}
  ],
  bug: [
    {id:'bite',    label:'ë²Œë ˆë¨¹ìŒ', power:11, mtype:'bug'},
    {id:'cut',     label:'ì‹¤ë² ê¸°', power:10, mtype:'bug'},
    {id:'cocoon',  label:'ê³ ì¹˜(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.14, mtype:'bug'}
  ],
  ghost: [
    {id:'shadow',  label:'ì„€ë„ë³¼', power:13, mtype:'ghost'},
    {id:'lick',    label:'í•¥ê¸°', power:9, mtype:'ghost'},
    {id:'veil',    label:'ì˜í˜¼ë³´í˜¸(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.14, mtype:'ghost'}
  ],
  dragon: [
    {id:'breath',  label:'ìš©ì˜ìˆ¨ê²°', power:13, mtype:'dragon'},
    {id:'claw',    label:'ë“œë˜ê³¤í´ë¡œ', power:12, mtype:'dragon'},
    {id:'scale',   label:'ë¹„ëŠ˜ë³´í˜¸(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.14, mtype:'dragon'}
  ],
  dark: [
    {id:'bite',    label:'ê¹¨ë¬¼ê¸°', power:12, mtype:'dark'},
    {id:'slash',   label:'ì•¼ìŠµ', power:11, mtype:'dark'},
    {id:'shroud',  label:'ê·¸ë¦¼ìë§‰(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.14, mtype:'dark'}
  ],
  steel: [
    {id:'iron',    label:'ì•„ì´ì–¸í—¤ë“œ', power:13, mtype:'steel'},
    {id:'metal',   label:'ë©”íƒˆí´ë¡œ', power:12, mtype:'steel'},
    {id:'polish',  label:'ì—°ë§ˆ(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.14, mtype:'steel'}
  ],
  fairy: [
    {id:'moon',    label:'ë¬¸í¬ìŠ¤', power:13, mtype:'fairy'},
    {id:'kiss',    label:'ë“œë ˆì´ë‹í‚¤ìŠ¤', power:11, mtype:'fairy'},
    {id:'charm',   label:'ë§¤í˜¹(ì†ŒíšŒë³µ)', power:0, effect:'heal', amount:0.16, mtype:'fairy'}
  ]
};

const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
let __UID = 1;
const newUID = () => `u${(__UID++).toString(36)}`;

/* 18íƒ€ì… Ã— 5 = 90ì¢… ìƒì„± */
const DEX = [];
for (const type of TYPES){
  const names = BASE_NAMES[type];
  for (let i=0;i<5;i++){
    const baseHP = {
      electric:35, fire:30, water:30, grass:32, rock:34, flying:28, poison:30, ice:29, psychic:28, ground:33,
      normal:32, fighting:33, bug:28, ghost:29, dragon:34, dark:31, steel:36, fairy:30
    }[type] || 30;
    const level = rnd(3,6);
    const maxHP = Math.round(baseHP + (i*2));
    const sid = `${type}-${i}`;
    DEX.push({ sid, type, name:names[i], level, maxHP, moves: TYPE_MOVESETS[type] });
  }
}
/* ì „ì„¤ 3ì¢…(ì „ì„¤ ì”ë”” ì „ìš©) */
const LEGENDS = [
  { sid:'legend-flarebeast', name:'í™”ìš°(Flarebeast)',  type:'fire',     level:12, maxHP:60, moves: TYPE_MOVESETS.fire, legend:true },
  { sid:'legend-aqualynx',   name:'ìˆ˜ë ¹(Aqualynx)',    type:'water',    level:12, maxHP:60, moves: TYPE_MOVESETS.water, legend:true },
  { sid:'legend-voltiger',   name:'ë‡Œí˜¸(Voltiger)',    type:'electric', level:12, maxHP:60, moves: TYPE_MOVESETS.electric, legend:true }
];

const wildPool = DEX.map(s=>({ ...s }));
const legendPool = LEGENDS.map(s=>({ ...s }));

/* =========================
   2) ìƒì„±í‘œ/ë°°ìœ¨ + STAB
========================= */
const EFFECT = {
  normal:   { rock:0.5, ghost:0, steel:0.5 },
  fire:     { grass:2, ice:2, bug:2, steel:2, fire:0.5, water:0.5, rock:0.5, dragon:0.5 },
  water:    { fire:2, ground:2, rock:2, water:0.5, grass:0.5, dragon:0.5 },
  electric: { water:2, flying:2, electric:0.5, grass:0.5, dragon:0.5, ground:0 },
  grass:    { water:2, ground:2, rock:2, fire:0.5, grass:0.5, poison:0.5, flying:0.5, bug:0.5, dragon:0.5, steel:0.5 },
  ice:      { grass:2, ground:2, flying:2, dragon:2, water:0.5, fire:0.5, ice:0.5, steel:0.5 },
  fighting: { normal:2, ice:2, rock:2, dark:2, steel:2, poison:0.5, flying:0.5, psychic:0.5, bug:0.5, fairy:0.5, ghost:0 },
  poison:   { grass:2, fairy:2, poison:0.5, ground:0.5, rock:0.5, ghost:0.5, steel:0 },
  ground:   { fire:2, electric:2, poison:2, rock:2, steel:2, grass:0.5, bug:0.5, flying:0 },
  flying:   { grass:2, fighting:2, bug:2, electric:0.5, rock:0.5, steel:0.5 },
  psychic:  { fighting:2, poison:2, psychic:0.5, steel:0.5, dark:0 },
  bug:      { grass:2, psychic:2, dark:2, fire:0.5, fighting:0.5, poison:0.5, flying:0.5, ghost:0.5, steel:0.5, fairy:0.5 },
  rock:     { fire:2, ice:2, flying:2, bug:2, fighting:0.5, ground:0.5, steel:0.5 },
  ghost:    { psychic:2, ghost:2, dark:0.5, normal:0 },
  dragon:   { dragon:2, steel:0.5, fairy:0 },
  dark:     { psychic:2, ghost:2, fighting:0.5, dark:0.5, fairy:0.5 },
  steel:    { ice:2, rock:2, fairy:2, fire:0.5, water:0.5, electric:0.5, steel:0.5 },
  fairy:    { fighting:2, dragon:2, dark:2, fire:0.5, poison:0.5, steel:0.5 }
};
const STAB = 1.5;
function typeEffect(mtype, defType){
  const row = EFFECT[mtype];
  if (!row) return 1;
  const v = row[defType];
  return v ?? 1;
}

/* =========================
   3) ìƒíƒœ/ìœ í‹¸/ë Œë”/ë„ê°/ë‹¤ì´ë§¥ìŠ¤/í€˜ìŠ¤íŠ¸/íŠ¸ë ˆì´ë„ˆ/í¬íšUI
========================= */
const camera = document.getElementById('camera');
const map = document.getElementById('map');
const player = document.getElementById('player');
const center = document.getElementById('center');
const centerUI = document.getElementById('centerUI');
const pList = document.getElementById('party');
const tipEl = document.getElementById('tip');
const capInfo = document.getElementById('capInfo');
const bandInfo = document.getElementById('bandInfo');
const trainerNPC = document.getElementById('trainerNPC');

const dexUI = document.getElementById('dexUI');
const dexListEl = document.getElementById('dexList');

const qEl5 = document.getElementById('qCatch5');
const qEl10 = document.getElementById('qCatch10');
const qElType = document.getElementById('qType');

const battle = document.getElementById('battle');
const logBox = document.getElementById('log');
const pHP = document.getElementById('pHP');
const wHP = document.getElementById('wHP');
const pStatusSpan = document.getElementById('pStatus');
const wStatusSpan = document.getElementById('wStatus');
const act1 = document.getElementById('act1');
const act2 = document.getElementById('act2');
const act3 = document.getElementById('act3');
const gmaxBtn = document.getElementById('gmaxBtn');
const catchBtn = document.getElementById('catchBtn');

const swapUI = document.getElementById('swapUI');
const swapList = document.getElementById('swapList');
const swapCancel = document.getElementById('swapCancel');

const state = {
  world: { w: 2000, h: 1200, vw: 900, vh: 560 },
  pos: { x: 260, y: 260 },
  inBattle: false,
  battleType: 'wild', // 'wild' | 'trainer'
  inGrass: false,
  inLegendGrass: false,
  party: [
    { uid: newUID(), sid:'electric-0', name:'í”¼ì¹´ì¸„', level:5, maxHP:35, hp:35, type:'electric', moves: TYPE_MOVESETS.electric, fainted:false, status:null, starter:true }
  ],
  activeIndex: 0,
  wild: null,
  pokedex: {}, // sid -> {name,type,level,maxHP?,caught:true}
  koAwardedThisBattle: false,
  dexSwapSid: null,
  hasDynaBand: false,
  gmax: { active:false, used:false, turns:0, targetIndex:null, moves:[] },
  quests: {
    catch5: { progress:0, goal:5, completed:false },
    catch10:{ progress:0, goal:10, completed:false },
    type:   { target: null, progress:0, goal:3, cycles:0 }
  },
  trainer: {
    name: 'íŠ¸ë ˆì´ë„ˆ ë¯¼í˜¸',
    defeated: false,
    index: 0,
    team: []
  },
  pendingCatch: null // í¬ì¼“ëª¬ë³¼ë¡œ ì¡ì€ ê°œì²´(êµì²´ ëŒ€ê¸°)
};

function randomType(){ return TYPES[Math.floor(Math.random()*TYPES.length)]; }
function ensureTypeQuestTarget(){ if (!state.quests.type.target) state.quests.type.target = randomType(); }
ensureTypeQuestTarget();

const keys = new Set();
const clamp = (v,min,max)=>Math.max(min, Math.min(max, v));
const safe = (v, d)=> (v==null ? d : v);
function hpPct(mon){ return Math.max(0, Math.round(mon.hp/mon.maxHP*100)); }
function hpClass(p){ return p>50?'hp-green':p>20?'hp-yellow':'hp-red'; }
function isFainted(m){ return !m || m.hp<=0; }
function statusLabel(s){
  if (!s) return '';
  if (s.type==='paralysis') return `ë§ˆë¹„(${s.turns}í„´)`;
  if (s.type==='poison') return `ë…`;
  return '';
}
function ensureMoves(mon){
  if (!mon) return null;
  if (!mon.moves || mon.moves.length<3) mon.moves = TYPE_MOVESETS[mon.type] || TYPE_MOVESETS.normal;
  return mon;
}
function partyCount(){ return state.party.length; }
function partyHasSid(sid){ return state.party.some(p=>p.sid===sid); }

/* ë„ê° ë“±ë¡/ì¤‘ë³µ ì²˜ë¦¬ */
function registerPokedex(mon){
  if (!mon) return false;
  if (!state.pokedex[mon.sid]){
    state.pokedex[mon.sid] = { name: mon.name, type: mon.type, level: mon.level, maxHP: mon.maxHP, caught:true };
    return true;
  } else {
    state.pokedex[mon.sid].level = Math.max(state.pokedex[mon.sid].level, mon.level);
    state.pokedex[mon.sid].maxHP = Math.max(state.pokedex[mon.sid].maxHP||0, mon.maxHP||0);
    return false;
  }
}

/* ë ˆë²¨ì—… ê·œì¹™ */
function levelUp(mon, gain=1){
  if (!mon) return;
  mon.level += gain;
  mon.maxHP += 2*gain;
  mon.hp = mon.maxHP;
}

/* DEX â†’ ê°œì²´ ìƒì„± (DEX ì—†ìœ¼ë©´ ë„ê° ë ˆì½”ë“œë¡œ ë³µì›) */
function createMonFromDex(sid){
  const dexRec = state.pokedex[sid];
  const base = DEX.find(d=>d.sid===sid);
  if (!dexRec && !base) return null;
  const ref = base || { sid, type: dexRec.type, name: dexRec.name, level: dexRec.level, maxHP: dexRec.maxHP||40, moves: TYPE_MOVESETS[dexRec.type] };
  const extra = Math.max(0, (dexRec?.level||ref.level) - ref.level);
  return {
    uid: newUID(),
    sid: ref.sid, name: ref.name, type: ref.type,
    level: (dexRec?.level||ref.level),
    maxHP: ref.maxHP + 2*extra,
    hp: ref.maxHP + 2*extra,
    status:null, fainted:false, moves: TYPE_MOVESETS[ref.type]
  };
}

/* íŒŒí‹° ë Œë” */
function renderParty(){
  pList.innerHTML = "";
  const replaceMode = !!state.dexSwapSid;
  state.party.forEach((m,i)=>{
    ensureMoves(m);
    const li = document.createElement('li');
    li.classList.toggle('active', i===state.activeIndex);
    li.classList.toggle('fainted', isFainted(m));
    const sTxt = m?.status?` Â· ${statusLabel(m.status)}`:'';
    const disabled = replaceMode ? '' : (isFainted(m)?'disabled':'');
    const label = replaceMode ? 'ì—¬ê¸°ë¡œ êµì²´' : (i===state.activeIndex?'ì‚¬ìš©ì¤‘':'í™œì„±í™”');
    li.innerHTML = `
      <div class="meta"><b>${safe(m?.name,'???')}</b> <span class="badge">${safe(m?.type,'?')}</span> Lv.${safe(m?.level,'?')}
        <div class="hp">HP ${safe(m?.hp,'?')}/${safe(m?.maxHP,'?')}${isFainted(m)?' Â· ê¸°ì ˆ':''}${sTxt}</div>
      </div>
      <button class="btn" ${disabled}>${label}</button>`;
    li.querySelector('button').onclick = ()=>{
      if (state.dexSwapSid){
        const newMon = createMonFromDex(state.dexSwapSid);
        if (!newMon){ state.dexSwapSid = null; renderDex(); renderParty(); return; }
        state.party[i] = newMon;
        state.activeIndex = i;
        state.dexSwapSid = null;
        renderParty(); renderDex();
        log('âœ… ë„ê°ì—ì„œ ì„ íƒí•œ í¬ì¼“ëª¬ìœ¼ë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.');
        if (state.inBattle) syncBattleUI();
        return;
      }
      if (isFainted(m)) return;
      state.activeIndex = i;
      renderParty();
      if (state.inBattle) syncBattleUI();
    };
    pList.appendChild(li);
  });
  capInfo.textContent = `${partyCount()} / 5`;
  bandInfo.classList.toggle('off', !state.hasDynaBand);
  bandInfo.innerHTML = `<span class="dot"></span> ë‹¤ì´ë§¥ìŠ¤ ë°´ë“œ: ${state.hasDynaBand?'ë³´ìœ ':'ì—†ìŒ'}`;
  renderQuests();
}

/* í€˜ìŠ¤íŠ¸ ë Œë” */
function renderQuests(){
  const q5 = state.quests.catch5;
  const q10 = state.quests.catch10;
  const qt = state.quests.type;
  qEl5.innerHTML = q5.completed
    ? `5ë§ˆë¦¬ ì¡ê¸°: <span class="qdone">ì™„ë£Œ</span> (ë‹¤ì´ë§¥ìŠ¤ ë°´ë“œ íšë“)`
    : `5ë§ˆë¦¬ ì¡ê¸°: ${Math.min(q5.progress,q5.goal)}/${q5.goal}`;
  qEl10.innerHTML = q10.completed
    ? `10ë§ˆë¦¬ ì¡ê¸°: <span class="qdone">ì™„ë£Œ</span> (íŒŒí‹° ì „ì› ë ˆë²¨ +1 ìˆ˜ë ¹)`
    : `10ë§ˆë¦¬ ì¡ê¸°: ${Math.min(q10.progress,q10.goal)}/${q10.goal}`;
  const tname = TYPE_KO[qt.target] || qt.target || '-';
  qElType.innerHTML = `íŠ¹ì • íƒ€ì…(3ë§ˆë¦¬): <span class="qtype">${tname}</span> ${qt.progress}/${qt.goal} Â· ì™„ë£Œ ${qt.cycles}íšŒ`;
}

/* ë„ê° ë Œë” */
function renderDex(){
  dexListEl.innerHTML = "";
  const entries = Object.entries(state.pokedex);
  if (entries.length===0){
    dexListEl.innerHTML = `<div style="grid-column:1/-1; color:#64748b; padding:8px;">ì•„ì§ ì¡ì€ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  entries.sort((a,b)=> a[1].name.localeCompare(b[1].name, 'ko'));
  for (const [sid, rec] of entries){
    const inParty = partyHasSid(sid);
    const canAdd = partyCount()<5 && !inParty;
    const variant = sid.includes('-') ? sid.split('-').pop() : 'L';
    const item = document.createElement('div');
    item.className='dexItem';
    if (state.dexSwapSid===sid) item.classList.add('sel');
    item.innerHTML = `
      <div style="width:40px;height:40px;border-radius:8px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:800;">#${variant}</div>
      <div class="dexMeta"><b>${rec.name}</b> <span class="badge">${rec.type}</span><br>
        <span class="sub">ìµœê³  Lv.${rec.level}${inParty?' Â· íŒŒí‹°ì— ìˆìŒ':''}</span>
      </div>
      <button class="btn" ${canAdd?'':'disabled'}>${inParty?'íŒŒí‹°ì— ìˆìŒ': (partyCount()>=5?'ë¹ˆìë¦¬ ì—†ìŒ':'íŒŒí‹°ì— ë„£ê¸°')}</button>
    `;
    item.addEventListener('click', (ev)=>{
      if (ev.target && ev.target.tagName==='BUTTON') return;
      state.dexSwapSid = (state.dexSwapSid===sid ? null : sid);
      renderDex(); renderParty();
      if (state.dexSwapSid) log(`êµì²´ ëª¨ë“œ: ì¢Œì¸¡ íŒŒí‹°ì—ì„œ êµì²´í•  ì¹¸ì„ í´ë¦­í•˜ì„¸ìš”.`);
    });
    item.querySelector('button').onclick = (ev)=>{
      ev.stopPropagation();
      if (partyHasSid(sid)) return;
      if (partyCount()<5){
        const newMon = createMonFromDex(sid);
        if (!newMon) return;
        state.party.push(newMon);
        renderParty(); renderDex();
        log(`${rec.name}ì´(ê°€) íŒŒí‹°ì— í•©ë¥˜í–ˆìŠµë‹ˆë‹¤!`);
      }
    };
    dexListEl.appendChild(item);
  }
}

/* ë„ê° ì—´ê¸°/ë‹«ê¸° */
document.getElementById('openDexBtn').onclick = ()=>{ dexUI.style.display='flex'; renderDex(); };
document.getElementById('closeDex').onclick = ()=>{ dexUI.style.display='none'; state.dexSwapSid=null; renderParty(); };

/* =========================
   4) ì´ë™/ì„¼í„°/ì…ë ¥/ì ‘ê·¼ íŒì •
========================= */
function moveCamera(){
  const cx = clamp(state.pos.x - state.world.vw/2, 0, state.world.w - state.world.vw);
  const cy = clamp(state.pos.y - state.world.vh/2, 0, state.world.h - state.world.vh);
  map.style.left = -cx + "px";
  map.style.top  = -cy + "px";
  document.getElementById('where').textContent = `x:${Math.round(state.pos.x)} y:${Math.round(state.pos.y)}`;
}
function setPlayerPos(x,y){
  state.pos.x = clamp(x, 24, state.world.w-24);
  state.pos.y = clamp(y, 24, state.world.h-24);
  player.style.left = state.pos.x + "px";
  player.style.top  = state.pos.y + "px";
  moveCamera();
}
function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
}
function isOnGrass(){
  const patches = [...document.querySelectorAll('.grass:not(.legend)')];
  const p = {x:state.pos.x-14, y:state.pos.y-14, w:28, h:28};
  for (const g of patches){
    if (rectsOverlap(p.x,p.y,p.w,p.h,g.offsetLeft,g.offsetTop,g.offsetWidth,g.offsetHeight)) return true;
  }
  return false;
}
function isOnLegendGrass(){
  const patches = [...document.querySelectorAll('.grass.legend')];
  const p = {x:state.pos.x-14, y:state.pos.y-14, w:28, h:28};
  for (const g of patches){
    if (rectsOverlap(p.x,p.y,p.w,p.h,g.offsetLeft,g.offsetTop,g.offsetWidth,g.offsetHeight)) return true;
  }
  return false;
}
function nearCenterDoor(){
  const P = {x:state.pos.x-14, y:state.pos.y-14, w:28, h:28};
  const door = { x: center.offsetLeft+100, y:center.offsetTop+90, w:60, h:70 };
  return rectsOverlap(P.x,P.y,P.w,P.h, door.x,door.y,door.w,door.h);
}
function nearTrainer(){
  const P = {x:state.pos.x-14, y:state.pos.y-14, w:28, h:28};
  const T = { x: trainerNPC.offsetLeft, y:trainerNPC.offsetTop, w:24, h:24 };
  return rectsOverlap(P.x,P.y,P.w,P.h, T.x-10, T.y-10, T.w+20, T.h+20);
}

document.getElementById('healBtn').onclick = ()=> healAllImmediate();

document.addEventListener('keydown', e=>{
  keys.add(e.key);
  if (e.key.toLowerCase()==='e' && nearCenterDoor()){
    healAllImmediate();
  }
  if (e.key.toLowerCase()==='t' && nearTrainer() && !state.inBattle && !state.trainer.defeated){
    startTrainerBattle();
  }
});
document.addEventListener('keyup', e=> keys.delete(e.key));

function tick(){
  if (!state.inBattle){
    let dx=0, dy=0, s=4;
    if (keys.has('ArrowUp')) dy -= s;
    if (keys.has('ArrowDown')) dy += s;
    if (keys.has('ArrowLeft')) dx -= s;
    if (keys.has('ArrowRight')) dx += s;
    if (dx||dy){
      setPlayerPos(state.pos.x+dx, state.pos.y+dy);
      const onGrass = isOnGrass();
      const onLegend = isOnLegendGrass();
      state.inGrass = onGrass; state.inLegendGrass = onLegend;

      if (onLegend && Math.random()<0.10) startLegendEncounter();
      else if (onGrass && Math.random()<0.07) startEncounter();

      tipEl.textContent = onLegend ? 'ğŸŸª ì „ì„¤ ì”ë””: í¬ê·€ ì „ì„¤ì´ ì¶œí˜„!'
                       : onGrass  ? 'ì”ë””(ë°°í‹€ ê°€ëŠ¥ ì§€ì—­)'
                                  : 'ì”ë””ì—ì„œ ì•¼ìƒ í¬ì¼“ëª¬ì´ ì¶œí˜„';
    }
  }
  requestAnimationFrame(tick);
}
setPlayerPos(state.pos.x, state.pos.y);
requestAnimationFrame(tick);

/* ì„¼í„° */
function healAllImmediate(){
  state.party.forEach(m=>{ m.hp=m.maxHP; m.fainted=false; m.status=null; });
  renderParty(); if (state.inBattle) syncBattleUI();
  tipEl.textContent = 'ğŸ’– í¬ì¼“ëª¬ì„¼í„°: íŒŒí‹° ì „ì› íšŒë³µ!';
}
document.getElementById('closeCenter').onclick = ()=> centerUI.style.display='none';
document.getElementById('healAll').onclick = ()=>{
  healAllImmediate(); centerUI.style.display='none';
};

/* =========================
   5) ë°°í‹€/ìƒíƒœ + KO + (í€˜ìŠ¤íŠ¸ ë³´ìƒ) + ê±°ë‹¤ì´ë§¥ìŠ¤ + ì „ì„¤/íŠ¸ë ˆì´ë„ˆ
========================= */

/* ê±°ë‹¤ì´ ê¸°ìˆ  ëª©ë¡ */
const GMAX_MOVES = [
  {label:'ê±°ë‹¤ì´ê°ë¡œ', type:'grass'},   {label:'ê±°ë‹¤ì´ì˜¥ì—¼', type:'fire'},
  {label:'ê±°ë‹¤ì´ê°ì‡ ', type:'dragon'},  {label:'ê±°ë‹¤ì´ìœµê²©', type:'steel'},
  {label:'ê±°ë‹¤ì´ê°ì „', type:'electric'},{label:'ê±°ë‹¤ì´ì¼ê²©', type:'dark'},
  {label:'ê±°ë‹¤ì´ê°•ì² ì§„', type:'steel'}, {label:'ê±°ë‹¤ì´ì—°ê²©', type:'water'},
  {label:'ê±°ë‹¤ì´ê³ í˜¹', type:'bug'},     {label:'ê±°ë‹¤ì´ì¬ìƒ', type:'normal'},
  {label:'ê±°ë‹¤ì´ê¸ˆí™”', type:'normal'},   {label:'ê±°ë‹¤ì´ì €ê²©', type:'water'},
  {label:'ê±°ë‹¤ì´ë‚œíƒ€', type:'grass'},   {label:'ê±°ë‹¤ì´ì²œë„', type:'psychic'},
  {label:'ê±°ë‹¤ì´ë‹¨ì›', type:'fairy'},   {label:'ê±°ë‹¤ì´ì²œë²Œ', type:'fairy'},
  {label:'ê±°ë‹¤ì´ë§Œë¢°', type:'electric'},{label:'ê±°ë‹¤ì´í¸ë‹¬', type:'grass'},
  {label:'ê±°ë‹¤ì´ë°±í™”', type:'fire'},    {label:'ê±°ë‹¤ì´í¬ê²©', type:'water'},
  {label:'ê±°ë‹¤ì´ë¶„ì„', type:'rock'},    {label:'ê±°ë‹¤ì´í¬ë§', type:'water'},
  {label:'ê±°ë‹¤ì´ì‚¬ì§„', type:'ground'},  {label:'ê±°ë‹¤ì´í¬ì˜¹', type:'normal'},
  {label:'ê±°ë‹¤ì´ì‚°ê²©', type:'grass'},   {label:'ê±°ë‹¤ì´í’ê²©', type:'flying'},
  {label:'ê±°ë‹¤ì´ì„ ìœ¨', type:'ice'},     {label:'ê±°ë‹¤ì´í™”ì—¼êµ¬', type:'fire'},
  {label:'ê±°ë‹¤ì´ìˆ˜ë§ˆ', type:'dark'},    {label:'ê±°ë‹¤ì´í™˜ì˜', type:'ghost'},
  {label:'ê±°ë‹¤ì´ì•…ì·¨', type:'poison'},  {label:'ê±°ë‹¤ì´íšŒì‹¬ê²©', type:'fighting'},
  {label:'ê±°ë‹¤ì´ì•”ì§„', type:'water'},
];

function pickGmaxMovesFor(mon){
  const my = mon.type;
  const pool = GMAX_MOVES.filter(m=>m.type===my);
  const normals = GMAX_MOVES.filter(m=>m.type==='normal');
  const picks = [];
  while (pool.length && picks.length<3){ const i=Math.floor(Math.random()*pool.length); const sel=pool.splice(i,1)[0]; picks.push({ ...sel, power:15, mtype: sel.type }); }
  while (picks.length<3 && normals.length){ const i=Math.floor(Math.random()*normals.length); const sel=normals.splice(i,1)[0]; picks.push({ ...sel, power:15, mtype: 'normal' }); }
  while (picks.length<3){ const sel=GMAX_MOVES[Math.floor(Math.random()*GMAX_MOVES.length)]; picks.push({ ...sel, power:15, mtype: sel.type }); }
  return picks;
}

function log(t){ logBox.innerHTML += `<div>â€¢ ${t}</div>`; logBox.scrollTop = logBox.scrollHeight; }
function setStatusBadge(el, s){ if (!el) return; if (!s){ el.style.display='none'; el.textContent=''; return; } el.style.display='inline-block'; el.textContent = statusLabel(s); }
function updateGmaxButton(){
  const can = state.inBattle && state.hasDynaBand && !state.gmax.used && !state.gmax.active && !isFainted(state.party[state.activeIndex]);
  gmaxBtn.style.display = can ? 'inline-block' : 'none';
}
function syncBattleUI(){
  if (!state.inBattle) return;
  const me = ensureMoves(state.party[state.activeIndex]);
  const w = state.wild;
  if (!me || !w){ return; }

  const pNameEl = document.getElementById('pName');
  const wNameEl = document.getElementById('wName');
  const foePrefix = (state.battleType==='trainer') ? `${state.trainer.name}ì˜ ` : (w.legend?'ì „ì„¤ì˜ ':'ì•¼ìƒì˜ ');
  if (pNameEl?.firstChild) pNameEl.firstChild.textContent = `${safe(me.name,'???')} Lv.${safe(me.level,'?')}${isFainted(me)?' (ê¸°ì ˆ)':''} `;
  if (wNameEl?.firstChild) wNameEl.firstChild.textContent = `${foePrefix}${safe(w.name,'???')} Lv.${safe(w.level,'?')} `;

  const pw = hpPct(me); pHP.style.width = pw+"%"; pHP.className = hpClass(pw); setStatusBadge(pStatusSpan, me.status);
  const ww = hpPct(w); wHP.style.width = ww+"%"; wHP.className = hpClass(ww); setStatusBadge(wStatusSpan, w.status);

  if (state.gmax.active) {
    act1.textContent = state.gmax.moves[0]?.label || 'ê±°ë‹¤ì´ ê¸°ìˆ  1';
    act2.textContent = state.gmax.moves[1]?.label || 'ê±°ë‹¤ì´ ê¸°ìˆ  2';
    act3.textContent = state.gmax.moves[2]?.label || 'ê±°ë‹¤ì´ ê¸°ìˆ  3';
  } else {
    act1.textContent = me.moves[0].label; act2.textContent = me.moves[1].label; act3.textContent = me.moves[2].label;
  }

  document.getElementById('playerMon').classList.toggle('gmax', state.gmax.active);
  drawMon(document.getElementById('playerMon'), me);
  drawMon(document.getElementById('wildMon'), w);
  updateGmaxButton();
}

/* ì „íˆ¬ ì‹œì‘ */
function startEncounter(){
  if (state.party.every(isFainted)) return;
  state.inBattle = true; state.battleType='wild';
  state.koAwardedThisBattle = false;
  state.gmax = { active:false, used:false, turns:3, targetIndex:null, moves:[] };
  battle.style.display='block'; logBox.innerHTML="";
  const base = wildPool[Math.floor(Math.random()*wildPool.length)];
  state.wild = { ...base, uid: newUID(), hp: base.maxHP, status:null };
  if (isFainted(state.party[state.activeIndex])){
    const alt = state.party.findIndex(m=>!isFainted(m)); if (alt>=0) state.activeIndex = alt;
  }
  syncBattleUI(); catchBtn.disabled = true;
  log(`ì•¼ìƒì˜ ${state.wild.name}ê°€ ë‚˜íƒ€ë‚¬ë‹¤!`);
}
function startLegendEncounter(){
  if (state.party.every(isFainted)) return;
  state.inBattle = true; state.battleType='wild';
  state.koAwardedThisBattle = false;
  state.gmax = { active:false, used:false, turns:3, targetIndex:null, moves:[] };
  battle.style.display='block'; logBox.innerHTML="";
  const base = legendPool[Math.floor(Math.random()*legendPool.length)];
  state.wild = { ...base, uid: newUID(), hp: base.maxHP, status:null, legend:true };
  if (isFainted(state.party[state.activeIndex])){
    const alt = state.party.findIndex(m=>!isFainted(m)); if (alt>=0) state.activeIndex = alt;
  }
  syncBattleUI(); catchBtn.disabled = true;
  log(`âœ¨ ì „ì„¤ì˜ ${state.wild.name}ì´(ê°€) ëª¨ìŠµì„ ë“œëŸ¬ëƒˆë‹¤!`);
}
function buildTrainerTeam(){
  if (state.trainer.team.length) return;
  const types = ['fighting','rock','psychic'];
  const team = types.map(t=>{
    const cand = DEX.find(d=>d.type===t) || DEX[0];
    const lvl = rnd(6,8);
    return { uid:newUID(), sid:cand.sid, name:cand.name, type:cand.type, level:lvl, maxHP:cand.maxHP+6, hp:cand.maxHP+6, moves: TYPE_MOVESETS[cand.type], status:null };
  });
  state.trainer.team = team;
}
buildTrainerTeam();

function startTrainerBattle(){
  if (state.party.every(isFainted)) return;
  if (state.trainer.defeated) { tipEl.textContent='ì´ë¯¸ ìŠ¹ë¦¬í•œ íŠ¸ë ˆì´ë„ˆì…ë‹ˆë‹¤.'; return; }
  state.inBattle = true; state.battleType='trainer';
  state.koAwardedThisBattle = false;
  state.trainer.index = 0;
  state.gmax = { active:false, used:false, turns:3, targetIndex:null, moves:[] };
  battle.style.display='block'; logBox.innerHTML="";
  const foe = state.trainer.team[state.trainer.index];
  state.wild = { ...foe, uid:newUID(), status:null };
  if (isFainted(state.party[state.activeIndex])){
    const alt = state.party.findIndex(m=>!isFainted(m)); if (alt>=0) state.activeIndex = alt;
  }
  syncBattleUI(); catchBtn.disabled = true;
  log(`ğŸ¤ ${state.trainer.name}ê°€ ë°°í‹€ì„ ê±¸ì–´ì™”ë‹¤!`);
}

function endBattle(){
  state.inBattle = false;
  state.wild = null;
  battle.style.display = 'none';
  logBox.innerHTML = "";
  catchBtn.disabled = true;
  document.getElementById('playerMon').classList.remove('gmax');
}

/* ê±°ë‹¤ì´ë§¥ìŠ¤ */
function triggerGmax(){
  const me = state.party[state.activeIndex];
  if (!state.inBattle || !state.hasDynaBand || state.gmax.used || state.gmax.active || isFainted(me)) return;
  state.gmax.active = true; state.gmax.used = true; state.gmax.turns = 3; state.gmax.targetIndex = state.activeIndex;
  me._origMaxHP = me.maxHP; me.maxHP = me.maxHP * 2; me.hp = Math.min(me.maxHP, me.hp + me._origMaxHP);
  state.gmax.moves = pickGmaxMovesFor(me);
  syncBattleUI(); renderParty();
  log('ğŸ”´ ê±°ë‹¤ì´ë§¥ìŠ¤! í¬ì¼“ëª¬ì´ ê±°ëŒ€í•´ì¡Œë‹¤!');
}
gmaxBtn.onclick = triggerGmax;

function maybeTickGmaxTurnsAfterPlayer(){
  if (state.gmax.active){
    state.gmax.turns--;
    if (state.gmax.turns<=0){
      const me = state.party[state.gmax.targetIndex ?? state.activeIndex];
      if (me && me._origMaxHP){ me.maxHP = me._origMaxHP; delete me._origMaxHP; me.hp = Math.min(me.hp, me.maxHP); }
      state.gmax.active=false;
      log('ğŸ”» ê±°ë‹¤ì´ë§¥ìŠ¤ê°€ í•´ì œë˜ì—ˆë‹¤.');
      syncBattleUI(); renderParty();
    } else { syncBattleUI(); }
  }
}

function setActions(on){
  ['act1','act2','act3','runBtn','switchBtn'].forEach(id=>{
    const el = document.getElementById(id);
    el.disabled = !on;
  });
  const canCatch = state.inBattle &&
                   state.battleType === 'wild' &&
                   state.wild &&
                   state.wild.hp <= 0;
  catchBtn.disabled = !canCatch;
  updateGmaxButton();
}

/* ëŒ€ë¯¸ì§€/ìƒì„± */
function baseDamage(pwr){ return pwr + Math.floor(Math.random()*5); }
function calcDamage(attacker, move, defender, isPlayerAttacker=false){
  let raw = baseDamage(move.power || 0);
  const stab = (move.mtype && move.mtype===attacker.type) ? STAB : 1;
  const eff = typeEffect(move.mtype || 'normal', defender.type);
  if (isPlayerAttacker && state.gmax.active) raw = Math.floor(raw * 1.8);
  if (!isPlayerAttacker && state.gmax.active && state.gmax.targetIndex===state.activeIndex) raw = Math.floor(raw * 0.7);
  return { dmg: Math.max(0, Math.floor(raw * stab * eff)), eff };
}
function effText(eff){
  if (eff===0) return 'í•˜ì§€ë§Œ í†µí•˜ì§€ ì•Šì•˜ë‹¤â€¦';
  if (eff>1) return 'íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤!';
  if (eff<1) return 'íš¨ê³¼ê°€ ë³„ë¡œì¸ ë“¯í•˜ë‹¤â€¦';
  return '';
}

/* ìƒíƒœ ë„ìš°ë¯¸ */
function tryParalyze(target){ if (!target?.status){ target.status={type:'paralysis', turns:3}; return true; } return false; }
function tryPoison(target){ if (!target?.status){ target.status={type:'poison', next: Date.now()+5000}; return true; } return false; }

/* KO ë³´ìƒ (í”Œë ˆì´ì–´ ì¸¡) */
function grantKOBonusOnce(){
  if (state.koAwardedThisBattle) return;
  state.koAwardedThisBattle = true;
  const me = state.party[state.activeIndex];
  if (me && !isFainted(me)){ levelUp(me, 1); renderParty(); syncBattleUI(); log(`ğŸ† ${safe(me?.name,'í¬ì¼“ëª¬')}ì´(ê°€) ìƒëŒ€ë¥¼ ì“°ëŸ¬ëœ¨ë ¤ ë ˆë²¨ì´ ì˜¬ëë‹¤! (+1)`); }
}

/* ì ì´ ì“°ëŸ¬ì¡Œì„ ë•Œ ê³µí†µ ì²˜ë¦¬ */
function onEnemyFainted(){
  grantKOBonusOnce();
  if (state.battleType==='trainer'){
    const t = state.trainer;
    t.index++;
    if (t.index < t.team.length){
      const next = t.team[t.index];
      state.wild = { ...next, uid:newUID(), status:null };
      log(`ğŸ” ${t.name}ì´(ê°€) ë‹¤ìŒ í¬ì¼“ëª¬ì„ ë‚´ë³´ëƒˆë‹¤: ${next.name}!`);
      syncBattleUI(); setActions(true);
    } else {
      t.defeated = true;
      log(`ğŸ–ï¸ ${t.name}ì„(ë¥¼) ì´ê²¼ë‹¤! ë°°í‹€ ì¢…ë£Œ.`);
      setTimeout(endBattle, 800);
    }
  } else {
    setActions(true); // HP 0ì´ë©´ í¬ì¼“ëª¬ë³¼ ë²„íŠ¼ í™œì„±í™”
  }
}

/* í”Œë ˆì´ì–´ í„´ */
act1.onclick = ()=> playerTurn(0);
act2.onclick = ()=> playerTurn(1);
act3.onclick = ()=> playerTurn(2);
document.getElementById('runBtn').onclick = ()=>{ log('ë„ë§ì³¤ë‹¤!'); setTimeout(endBattle,400); };
document.getElementById('switchBtn').onclick = ()=> log('êµì²´í•  í¬ì¼“ëª¬ì„ ì¢Œì¸¡ íŒŒí‹°ì—ì„œ ì„ íƒí•˜ì„¸ìš”.');
catchBtn.onclick = doCatch;

function playerTurn(mi){
  const me = ensureMoves(state.party[state.activeIndex]);
  if (!me){ log('ì˜¤ë¥˜: í¬ì¼“ëª¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  if (isFainted(me)){ log('ê¸°ì ˆí•´ì„œ í–‰ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'); return; }
  setActions(false);

  const mv = state.gmax.active ? state.gmax.moves[mi] : me.moves[mi];

  if (!state.gmax.active && mv.effect==='heal'){
    const amt = Math.ceil(me.maxHP * (mv.amount || 0.2));
    const before = me.hp; me.hp = Math.min(me.maxHP, me.hp + amt);
    syncBattleUI(); renderParty();
    log(`${safe(me.name,'í¬ì¼“ëª¬')}ì´(ê°€) ${mv.label}ë¡œ HP ${me.hp-before} íšŒë³µ!`);
    maybeTickGmaxTurnsAfterPlayer();
    return wildTurnAfterDelay();
  }

  const { dmg, eff } = calcDamage(me, mv, state.wild, true);
  if (eff===0){
    log(`${safe(me.name,'í¬ì¼“ëª¬')}ì˜ ${mv.label}! ${effText(eff)}`);
  } else {
    state.wild.hp = Math.max(0, state.wild.hp - dmg);
    log(`${safe(me.name,'í¬ì¼“ëª¬')}ì˜ ${mv.label}! ${dmg}ì˜ ëŒ€ë¯¸ì§€! ${effText(eff)}`);
  }

  if (!state.gmax.active && mv.effect==='paralyze' && eff>0){
    if (tryParalyze(state.wild)) log(`âš¡ ${safe(state.wild?.name,'ìƒëŒ€')}ì€(ëŠ”) ë§ˆë¹„ì— ê±¸ë ¸ë‹¤! (3í„´)`);
  }
  if (((state.gmax.active ? mv.type : mv.mtype)==='poison') && eff>0){
    if (tryPoison(state.wild)) log(`â˜ ï¸ ${safe(state.wild?.name,'ìƒëŒ€')}ì€(ëŠ”) ë…ì— ê±¸ë ¸ë‹¤! (5ì´ˆë§ˆë‹¤ -2)`);
  }

  syncBattleUI();
  if (state.wild.hp<=0){
    const foePrefix = (state.battleType==='trainer')? state.trainer.name : (state.wild.legend?'ì „ì„¤ì˜ ':'ì•¼ìƒì˜ ');
    log(`${foePrefix}${safe(state.wild?.name,'í¬ì¼“ëª¬')}ì„(ë¥¼) ì“°ëŸ¬ëœ¨ë ¸ë‹¤!`);
    onEnemyFainted();
    maybeTickGmaxTurnsAfterPlayer();
    return;
  }
  maybeTickGmaxTurnsAfterPlayer();
  wildTurnAfterDelay();
}

/* ì  í„´ */
function wildTurnAfterDelay(){
  setTimeout(()=>{
    const me = ensureMoves(state.party[state.activeIndex]);
    const w = state.wild;
    if (!w || !me){ setActions(true); return; }

    if (w.status && w.status.type==='paralysis' && w.status.turns>0){
      if (Math.random()<0.5){
        log(`${safe((state.battleType==='trainer'?state.trainer.name+'ì˜ ':'')+(w.name||'ìƒëŒ€'))}ì€(ëŠ”) ëª¸ì´ ì €ë ¤ì„œ ì›€ì§ì¼ ìˆ˜ ì—†ë‹¤!`);
        w.status.turns--;
        if (w.status.turns<=0){ log(`${safe(w.name,'ìƒëŒ€')}ì˜ ë§ˆë¹„ê°€ í’€ë ¸ë‹¤.`); w.status=null; }
        syncBattleUI(); setActions(true); return;
      } else {
        w.status.turns--;
        if (w.status.turns<=0){ log(`${safe(w.name,'ìƒëŒ€')}ì˜ ë§ˆë¹„ê°€ í’€ë ¸ë‹¤.`); w.status=null; }
      }
    }

    const mv = w.moves[Math.random()<0.6?0:1];
    const { dmg, eff } = calcDamage(w, mv, me, false);

    if (eff===0){
      log(`${safe((state.battleType==='trainer'?state.trainer.name+'ì˜ ':'')+(w.name||'ìƒëŒ€'))}ì˜ ${mv.label}! ${effText(eff)}`);
    } else {
      me.hp = Math.max(0, me.hp - dmg);
      log(`${safe((state.battleType==='trainer'?state.trainer.name+'ì˜ ':'')+(w.name||'ìƒëŒ€'))}ì˜ ${mv.label}! ${dmg}ì˜ ëŒ€ë¯¸ì§€! ${effText(eff)}`);
    }

    if (mv.mtype==='poison' && eff>0){
      if (tryPoison(me)) log(`â˜ ï¸ ${safe(me.name,'ë‚´ í¬ì¼“ëª¬')}ì´(ê°€) ë…ì— ê±¸ë ¸ë‹¤! (5ì´ˆë§ˆë‹¤ -2)`);
    }

    if (me.hp<=0){
      log(`${safe(me.name,'ë‚´ í¬ì¼“ëª¬')}ì´(ê°€) ê¸°ì ˆí–ˆë‹¤!`);
      const idx = state.party.findIndex(p=>!isFainted(p));
      if (idx === -1){ log('ì „íˆ¬ ë¶ˆëŠ¥! ì „íˆ¬ ì¢…ë£Œ.'); setTimeout(endBattle, 700); return; }
      state.activeIndex = idx; renderParty(); log(`ìë™ êµì²´ â†’ ${state.party[idx].name}`);
    }
    syncBattleUI(); renderParty();
    setActions(true);
  }, 450);
}

/* ë… DOT */
setInterval(()=>{
  if (!state.inBattle) return;
  const now = Date.now();
  const me = state.party[state.activeIndex];
  if (me && me.status && me.status.type==='poison' && me.hp>0 && now >= (me.status.next||0)){
    me.hp = Math.max(0, me.hp - 2);
    me.status.next = now + 5000;
    renderParty(); syncBattleUI();
    log(`â˜ ï¸ ${safe(me.name,'í¬ì¼“ëª¬')}ì€(ëŠ”) ë…ì˜ ëŒ€ë¯¸ì§€ë¥¼ ë°›ì•˜ë‹¤! (-2)`);
    if (me.hp<=0){
      log(`${safe(me.name,'í¬ì¼“ëª¬')}ì´(ê°€) ë…ìœ¼ë¡œ ì“°ëŸ¬ì¡Œë‹¤!`);
      const idx = state.party.findIndex(p=>!isFainted(p));
      if (idx === -1){ log('ì „íˆ¬ ë¶ˆëŠ¥! ì „íˆ¬ ì¢…ë£Œ.'); setTimeout(endBattle, 700); return; }
      state.activeIndex = idx; renderParty(); syncBattleUI();
      log(`ìë™ êµì²´ â†’ ${state.party[idx].name}`);
    }
  }
  const w = state.wild;
  if (w && w.status && w.status.type==='poison' && w.hp>0 && now >= (w.status.next||0)){
    w.hp = Math.max(0, w.hp - 2);
    w.status.next = now + 5000;
    syncBattleUI();
    log(`â˜ ï¸ ${state.battleType==='trainer'? state.trainer.name+'ì˜ ' : (w.legend?'ì „ì„¤ì˜ ':'ì•¼ìƒì˜ ')}${safe(w.name,'ìƒëŒ€')}ì€(ëŠ”) ë…ì˜ ëŒ€ë¯¸ì§€ë¥¼ ë°›ì•˜ë‹¤! (-2)`);
    if (w.hp<=0){
      log(`${state.battleType==='trainer'? state.trainer.name+'ì˜ ' : (w.legend?'ì „ì„¤ì˜ ':'ì•¼ìƒì˜ ')}${safe(w.name,'ìƒëŒ€')}ì´(ê°€) ë…ìœ¼ë¡œ ì“°ëŸ¬ì¡Œë‹¤!`);
      onEnemyFainted();
    }
  }
}, 250);

/* í€˜ìŠ¤íŠ¸: í¬íš ì¹´ìš´íŠ¸/ë³´ìƒ */
function onQuestCatch(mon){
  const q5 = state.quests.catch5, q10 = state.quests.catch10, qt = state.quests.type;
  if (!q5.completed){
    q5.progress++; if (q5.progress >= q5.goal){ q5.completed = true; state.hasDynaBand = true; log('ğŸ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ë‹¤ì´ë§¥ìŠ¤ ë°´ë“œë¥¼ íšë“í–ˆë‹¤!'); }
  }
  if (!q10.completed){
    q10.progress++; if (q10.progress >= q10.goal){ q10.completed = true; state.party.forEach(p=>levelUp(p,1)); log('ğŸ í€˜ìŠ¤íŠ¸ ì™„ë£Œ! íŒŒí‹° ì „ì› ë ˆë²¨ +1!'); }
  }
  ensureTypeQuestTarget();
  if (mon?.type === state.quests.type.target){
    qt.progress++;
    if (qt.progress >= qt.goal){
      qt.cycles++; qt.progress = 0;
      const me = state.party[state.activeIndex]; if (me) { levelUp(me,1); log(`ğŸ íƒ€ì… í€˜ìŠ¤íŠ¸ ì™„ë£Œ! ${me.name} ë ˆë²¨ +1!`); }
      let next = randomType(), guard=0; while (next===qt.target && guard<10){ next = randomType(); guard++; } qt.target = next;
      log(`ğŸ¯ ë‹¤ìŒ íƒ€ì… í€˜ìŠ¤íŠ¸ ëª©í‘œ: ${TYPE_KO[qt.target]||qt.target}`);
    }
  }
  renderParty(); renderQuests();
}

/* ====== í¬ì¼“ëª¬ë³¼: â€œì¡ìœ¼ë©´ êµì²´ë§Œâ€ í”Œë¡œìš° ====== */
function showSwapUI(caught){
  state.pendingCatch = caught;
  swapList.innerHTML = '';
  state.party.forEach((m,i)=>{
    const li = document.createElement('li');
    li.style.cssText = 'background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:8px;cursor:pointer';
    li.innerHTML = `<b>#${i+1} ${safe(m.name,'???')}</b> <span class="badge">${m.type}</span>
      <div class="hp" style="font-size:12px;color:#475569">Lv.${m.level} Â· HP ${m.hp}/${m.maxHP}${isFainted(m)?' Â· ê¸°ì ˆ':''}</div>`;
    li.onclick = ()=> replacePartySlot(i, caught);
    swapList.appendChild(li);
  });
  swapUI.style.display = 'flex';
}
function closeSwapUI(){
  swapUI.style.display = 'none';
  state.pendingCatch = null;
}
function replacePartySlot(i, caught){
  const newMon = {
    uid: newUID(), sid: caught.sid, name: caught.name, type: caught.type,
    level: caught.level, maxHP: caught.maxHP, hp: caught.maxHP,
    status:null, fainted:false, moves: caught.moves
  };
  state.party[i] = newMon;
  state.activeIndex = i;
  renderParty();
  log(`ğŸ” íŒŒí‹° ${i+1}ë²ˆì„ ${caught.name}(ìœ¼)ë¡œ êµì²´í–ˆìŠµë‹ˆë‹¤!`);
  closeSwapUI();
  setTimeout(endBattle, 500);
}
swapCancel.onclick = ()=>{
  log('í¬íš: ë„ê°ë§Œ ë“±ë¡í•˜ê³  íŒŒí‹°ëŠ” ìœ ì§€í–ˆìŠµë‹ˆë‹¤.');
  closeSwapUI();
  setTimeout(endBattle, 500);
};

/* í¬íš (êµì²´ ì „ìš©) */
function doCatch(){
  if (state.battleType === 'trainer'){
    log('íŠ¸ë ˆì´ë„ˆì˜ í¬ì¼“ëª¬ì€ ì¡ì„ ìˆ˜ ì—†ë‹¤!');
    return;
  }
  if (!(state.wild && state.wild.hp<=0)){
    log('ìƒëŒ€ HPë¥¼ 0ìœ¼ë¡œ ë§Œë“¤ë©´ í¬ì¼“ëª¬ë³¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.');
    return;
  }

  const w = state.wild;
  const inPartyIdx = state.party.findIndex(p=>p.sid===w.sid);
  const wasInDex = !!state.pokedex[w.sid];

  // ì¤‘ë³µ í¬íš: íŒŒí‹°ì— ê°™ì€ ì¢… ìˆìœ¼ë©´ ê·¸ ê°œì²´ë§Œ ë ˆë²¨ +1
  if (inPartyIdx >= 0){
    levelUp(state.party[inPartyIdx], 1);
    renderParty();
    log(`â­ ${w.name} ì¤‘ë³µ í¬íš: íŒŒí‹° ë™ì¼ ì¢… ë ˆë²¨ +1!`);
    onQuestCatch(w);
    setTimeout(endBattle, 600);
    return;
  }

  // ë„ê° ë¯¸ë“±ë¡ì´ë©´ ë“±ë¡
  if (!wasInDex){
    registerPokedex(w);
    log(`ğŸ“˜ ë„ê° ë“±ë¡: ${w.name}`);
  } else {
    log('ğŸ“˜ ì´ë¯¸ ë“±ë¡ëœ ì¢…ì…ë‹ˆë‹¤. (ë„ê° ë¯¸ì¶”ê°€)');
  }

  // íŒŒí‹° í™•ì¥ ì—†ìŒ â†’ ë°˜ë“œì‹œ êµì²´ UI
  onQuestCatch(w);
  showSwapUI(w);
}

/* =========================
   6) ìŠ¤í”„ë¼ì´íŠ¸ â€” ì „ì„¤ ì˜¤ë¼/ê°•ì¡° ì§€ì›
========================= */
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
function hashSid(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619);} return h>>>0;}
const TYPE_COLORS = {
  electric:[246,214,74], fire:[255,146,72], water:[93,183,255], grass:[47,191,113], rock:[154,161,166],
  flying:[147,176,255], poison:[167,139,250], ice:[139,210,255], psychic:[226,163,255], ground:[193,154,107],
  normal:[205,205,205], fighting:[210,90,70], bug:[170,195,75], ghost:[110,90,150], dragon:[100,120,220],
  dark:[90,80,70], steel:[170,170,190], fairy:[240,180,240]
};

function drawMon(canvas, mon){
  const ctx=canvas.getContext('2d'); const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  if (!mon){ return; }

  // ì „ì„¤ ì˜¤ë¼
  if (mon.legend){
    ctx.save();
    const aura = mon.type==='fire'?'rgba(255,80,40,.35)': mon.type==='water'?'rgba(60,150,255,.35)':'rgba(255,230,90,.35)';
    ctx.fillStyle=aura; ctx.beginPath(); ctx.ellipse(W/2, H-30, 110, 28, 0, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  } else {
    ctx.fillStyle='rgba(0,0,0,0.2)';
    ctx.beginPath(); ctx.ellipse(W/2, H-30, 80, 18, 0, 0, Math.PI*2); ctx.fill();
  }

  const rng = mulberry32(hashSid(mon.uid || mon.sid || mon.name || 'x'));
  const base = TYPE_COLORS[mon.type] || [200,200,200];
  const d = Math.floor(rng()*40)-20;
  const bodyColor = `rgb(${Math.max(0,Math.min(255,base[0]+d))},${Math.max(0,Math.min(255,base[1]+d))},${Math.max(0,Math.min(255,base[2]+d))})`;
  const accent = `rgba(${Math.max(0,Math.min(255,base[0]-d))},${Math.max(0,Math.min(255,base[1]-d))},${Math.max(0,Math.min(255,base[2]-d))},0.9)`;

  const cx=W/2, cy=120;
  const form = mon.legend ? 5 : Math.floor(rng()*6);
  ctx.fillStyle = bodyColor;
  switch(form){
    case 0: ctx.beginPath(); ctx.ellipse(cx,cy,60,45, rng()*1.2, 0, Math.PI*2); ctx.fill(); break;
    case 1: roundedRect(ctx,cx-60,cy-40,120,80, 24); ctx.fill(); break;
    case 2: poly(ctx, [[cx-50,cy+50],[cx,cy-55],[cx+50,cy+50]]); ctx.fill(); break;
    case 3: ctx.beginPath(); ctx.moveTo(cx-50,cy); ctx.bezierCurveTo(cx-40,cy-60,cx+40,cy-60,cx+50,cy); ctx.bezierCurveTo(cx+45,cy+60,cx-45,cy+60,cx-50,cy); ctx.closePath(); ctx.fill(); break;
    case 4: blob(ctx,cx,cy, rng); ctx.fill(); break;
    case 5: ctx.beginPath(); ctx.ellipse(cx,cy,56,68,0,0,Math.PI*2); ctx.fill(); break;
  }

  // ìŠ¤íŠ¸ë¼ì´í”„/ë””í…Œì¼
  const stripeCount = mon.legend ? 5 : 2 + Math.floor(rng()*4);
  ctx.fillStyle = accent;
  for(let i=0;i<stripeCount;i++){
    const a = (i - stripeCount/2) * 0.3 + (rng()*0.2);
    const rx = (mon.legend?28:20) + rng()*30, ry = (mon.legend?12:8) + rng()*18;
    ctx.beginPath(); ctx.ellipse(cx + Math.cos(a)*20, cy + Math.sin(a)*10, rx, ry, a, 0, Math.PI*2); ctx.globalAlpha=mon.legend?0.16:0.12; ctx.fill(); ctx.globalAlpha=1;
  }

  // ëˆˆ
  ctx.fillStyle = '#222';
  const eyeDx = 18 + rng()*14, eyeDy = -8 + rng()*6, eyeR = mon.legend ? 5 + rng()*3 : 4 + rng()*3;
  ctx.beginPath(); ctx.arc(cx-eyeDx, cy+eyeDy, eyeR, 0, Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(cx+eyeDx, cy+eyeDy, eyeR, 0, Math.PI*2); ctx.fill();

  // ì¥ì‹
  const deco = mon.legend ? 1 : Math.floor(rng()*3);
  ctx.fillStyle = accent;
  if (deco===0){ horn(ctx,cx-25,cy-50, rng); horn(ctx,cx+25,cy-50, rng); }
  else if (deco===1){ wing(ctx,cx-60,cy, -1, rng); wing(ctx,cx+60,cy, 1, rng); }
  else { fin(ctx,cx-35,cy+20, -1, rng); fin(ctx,cx+35,cy+20, 1, rng); }
}
function roundedRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function poly(ctx, pts){ctx.beginPath();ctx.moveTo(pts[0][0],pts[0][1]);for(let i=1;i<pts.length;i++)ctx.lineTo(pts[i][0],pts[i][1]);ctx.closePath();}
function blob(ctx,cx,cy,rng){ctx.beginPath();const n=6+Math.floor(rng()*4);for(let i=0;i<n;i++){const ang=i/n*Math.PI*2;const rad=40+rng()*18;const x=cx+Math.cos(ang)*rad,y=cy+Math.sin(ang)*(rad*0.8);if(i===0)ctx.moveTo(x,y);else ctx.quadraticCurveTo(cx,cy,x,y);}ctx.closePath();}
function horn(ctx,x,y,rng){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+12,y-28);ctx.lineTo(x+24,y);ctx.closePath();ctx.fill();}
function wing(ctx,x,y,dir,rng){ctx.beginPath();ctx.moveTo(x,y);ctx.quadraticCurveTo(x+dir*50,y-24,x+dir*90,y);ctx.quadraticCurveTo(x+dir*60,y+24,x,y);ctx.closePath();ctx.fillStyle='rgba(255,255,255,0.35)';ctx.fill();ctx.fillStyle='rgba(0,0,0,0.08)';ctx.stroke();}
function fin(ctx,x,y,dir,rng){ctx.beginPath();ctx.ellipse(x,y,24,12,dir*0.5,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fill();}

/* =========================
   7) ì´ˆê¸° ë Œë” + í…ŒìŠ¤íŠ¸
========================= */
renderParty();
registerPokedex(state.party[0]);
renderQuests();

(function tests(){
  console.assert(TYPES.length===18, 'íƒ€ì… ê°œìˆ˜(18) ì˜¤ë¥˜');
  console.assert(DEX.length===90, 'ë„ê° 90ì¢… ìƒì„± ì‹¤íŒ¨');
  console.assert(LEGENDS.length===3, 'ì „ì„¤ 3ì¢… ëˆ„ë½');
  console.assert(state.party[0].moves.length===3, 'ìŠ¤íƒ€í„° ê¸°ìˆ  ë¯¸í• ë‹¹');

  // ìƒì„±
  console.assert(typeEffect('water','fire')===2, 'ë¬¼â†’ë¶ˆ 2ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('electric','ground')===0, 'ì „ê¸°â†’ë•… 0ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('ground','flying')===0, 'ë•…â†’ë¹„í–‰ 0ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('grass','fire')===0.5, 'í’€â†’ë¶ˆ 0.5ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('normal','ghost')===0, 'ë…¸ë§â†’ê³ ìŠ¤íŠ¸ 0ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('fighting','rock')===2, 'ê²©íˆ¬â†’ë°”ìœ„ 2ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('steel','ice')===2, 'ê°•ì² â†’ì–¼ìŒ 2ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('fairy','dragon')===2, 'í˜ì–´ë¦¬â†’ë“œë˜ê³¤ 2ë°° ì‹¤íŒ¨');
  console.assert(typeEffect('dragon','fairy')===0, 'ë“œë˜ê³¤â†’í˜ì–´ë¦¬ 0ë°° ì‹¤íŒ¨');

  // ê±°ë‹¤ì´
  console.assert(GMAX_MOVES.length===33, 'ê±°ë‹¤ì´ ê¸°ìˆ  ê°œìˆ˜ 33 ì•„ë‹˜');
  const sel = pickGmaxMovesFor({type:'water'});
  console.assert(sel.length===3 && sel.every(m=>m.mtype==='water' || m.mtype==='normal'), 'ê±°ë‹¤ì´ ì„ íƒ ë¡œì§ ì˜¤ë¥˜');

  // ì „ì„¤ ë“±ë¡/ë³µì›
  const L = LEGENDS[0];
  registerPokedex(L);
  const restored = createMonFromDex(L.sid);
  console.assert(restored && restored.type===L.type, 'ì „ì„¤ ë„ê° ë³µì› ì‹¤íŒ¨');

  // íŠ¸ë ˆì´ë„ˆ ì„¸íŒ…
  console.assert(state.trainer.team.length===3, 'íŠ¸ë ˆì´ë„ˆ íŒ€ ìƒì„± ì‹¤íŒ¨');

  // í¬ì¼“ëª¬ë³¼ ë²„íŠ¼ í™œì„±í™” í…ŒìŠ¤íŠ¸
  state.inBattle = true; state.battleType = 'wild';
  state.wild = {hp:0, type:'normal', name:'í…ŒìŠ¤íŠ¸', level:3, maxHP:30};
  setActions(true);
  console.assert(!catchBtn.disabled, 'HP 0ì—ì„œ í¬ì¼“ëª¬ë³¼ ë²„íŠ¼ì´ í™œì„±í™”ë˜ì–´ì•¼ í•¨');
})();
</script>
</body>
</html>
